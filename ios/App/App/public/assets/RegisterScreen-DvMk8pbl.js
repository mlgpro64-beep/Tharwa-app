import{r as l,a as G,j as e,m as n,c as o,A as D,u as ne,f as le,b as oe,d as ce,U as L,g as de,X as me,h as ue,e as M,s as pe}from"./index-CzK-Wtpj.js";import{u as O}from"./useMutation-BXgiM4Zs.js";import{E as he}from"./eye-off-D3AByt6D.js";import{E as xe}from"./eye-yefYjQ94.js";import{A as fe}from"./arrow-left-eQXjCarb.js";import{P as W}from"./phone-BU10rKK_.js";import{L as _}from"./loader-circle-AYqjcifH.js";import{M as ge}from"./mail-DnD_Dbv3.js";import{L as ye}from"./lock-B56TYpix.js";import{U as be}from"./upload-CUoyT6Pu.js";import{F as ve}from"./file-check-B-PxUlvl.js";import"./utils-km2FGkQ4.js";const w=l.memo(function({icon:f,label:I,type:i="text",value:X,onChange:p,error:N,autoComplete:m,showPasswordToggle:a,showPassword:h,onTogglePassword:q,testId:k,dir:C,required:r}){const[A,d]=l.useState(!1),{i18n:T}=G(),u=T.language==="ar";return e.jsxs(n.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"relative",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:o("absolute top-1/2 -translate-y-1/2 text-muted-foreground",u?"right-4":"left-4"),children:e.jsx(f,{className:"w-5 h-5"})}),e.jsx("input",{type:a?h?"text":"password":i,value:X,onChange:p,onFocus:()=>d(!0),onBlur:()=>d(!1),placeholder:I,autoComplete:m,dir:C||(u?"rtl":"ltr"),required:r,className:o("w-full h-14 rounded-2xl glass-input text-foreground placeholder:text-muted-foreground focus:outline-none transition-all duration-200",u?"pr-12 pl-5":"pl-12 pr-5",N&&"border-destructive",A&&"ring-2 ring-primary/30",a&&(u?"pl-14":"pr-14"),u&&"text-right"),"data-testid":k}),a&&e.jsx("button",{type:"button",onClick:q,className:o("absolute top-1/2 -translate-y-1/2 p-2 text-muted-foreground hover:text-foreground transition-colors",u?"left-4":"right-4"),children:h?e.jsx(he,{className:"w-5 h-5"}):e.jsx(xe,{className:"w-5 h-5"})})]}),e.jsx(D,{children:N&&e.jsx(n.p,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},className:o("mt-2 text-xs text-destructive font-medium",u?"pr-1 text-right":"pl-1"),children:N})})]})}),Re=l.memo(function(){const[,f]=ne(),I=le(),{t:i,i18n:X}=G(),{userRole:p,setUser:N}=oe(),{toast:m}=ce(),a=X.language==="ar",h=l.useRef(null),k=new URLSearchParams(I).get("taskerType")||"general",C=p==="tasker"&&k==="specialized",[r,A]=l.useState({firstName:"",lastName:"",username:"",email:"",phone:"",password:""}),[d,T]=l.useState({}),[u,K]=l.useState(!1),[g,H]=l.useState(!1),[S,z]=l.useState(null),[$,R]=l.useState(null),[P,U]=l.useState(!1),[y,V]=l.useState(""),b=l.useCallback(t=>{if(!t)return{level:0,label:"",color:""};let s=0;return t.length>=6&&s++,t.length>=8&&s++,/[A-Z]/.test(t)&&s++,/[0-9]/.test(t)&&s++,/[^A-Za-z0-9]/.test(t)&&s++,s<=2?{level:1,label:i("auth.passwordWeak"),color:"bg-destructive"}:s<=3?{level:2,label:i("auth.passwordMedium"),color:"bg-warning"}:s<=4?{level:3,label:i("auth.passwordStrong"),color:"bg-success"}:{level:4,label:i("auth.passwordVeryStrong"),color:"bg-success"}},[i])(r.password),v=O({mutationFn:async t=>{const s=await M("POST","/api/auth/send-phone-otp",{phone:t,type:"registration"});if(!s.ok){const c=await s.json();throw new Error(c.error||"Failed to send OTP")}return s.json()},onSuccess:()=>{U(!0),m({title:a?"تم إرسال الرمز":"Code Sent",description:a?"تحقق من رسائلك SMS":"Check your SMS for the verification code"})},onError:t=>{let s=t.message;t.message.includes("already registered")&&(s=a?"رقم الجوال مسجل مسبقاً":"Phone number already registered"),m({title:a?"خطأ":"Error",description:s,variant:"destructive"})}}),E=O({mutationFn:async t=>{const s=await M("POST","/api/auth/verify-phone-otp",t);if(!s.ok){const c=await s.json();throw new Error(c.error||"Invalid OTP")}return s.json()},onSuccess:()=>{C&&!g?(H(!0),U(!1)):x.mutate({...r,certificateUrl:S||void 0})},onError:t=>{let s=t.message;(t.message.includes("Invalid")||t.message.includes("expired"))&&(s=a?"رمز التحقق غير صحيح أو منتهي الصلاحية":"Invalid or expired verification code"),m({title:a?"خطأ":"Error",description:s,variant:"destructive"})}}),x=O({mutationFn:async t=>{const s={...t,name:`${t.firstName} ${t.lastName}`.trim(),username:t.username.trim(),role:p};p==="tasker"&&(s.taskerType=k,s.verificationStatus=k==="specialized"?"pending":"approved",t.certificateUrl&&(s.certificateUrl=t.certificateUrl));const c=await M("POST","/api/auth/register",s);if(!c.ok){const F=await c.json();throw new Error(F.error||"Registration failed")}return c.json()},onSuccess:t=>{t.token&&pe(t.token),N(t.user),localStorage.setItem("userId",t.user.id),m(C?{title:i("auth.accountCreatedPending"),description:i("auth.pendingReviewDesc")}:{title:i("auth.accountCreated"),description:i("auth.welcomeTo",{appName:i("welcome.title")})}),f("/home")},onError:t=>{if(t.message.includes("Tenant")||t.message.includes("not found")&&t.message.includes("Tenant")){console.log("[Auth] Supabase Auth error suppressed during registration");return}let s=t.message;t.message.includes("email")||t.message.includes("users_email_key")?s=a?"البريد الإلكتروني مسجل مسبقاً":"Email already registered":t.message.includes("phone")||t.message.includes("users_phone_key")?s=a?"رقم الجوال مسجل مسبقاً":"Phone number already registered":t.message.includes("username")||t.message.includes("users_username_key")?s=a?"اسم المستخدم مسجل مسبقاً":"Username already registered":(t.message.includes("500")||t.message.includes("Internal Server Error"))&&(s=a?"خطأ في الخادم. يرجى المحاولة مرة أخرى":"Server error. Please try again"),m({title:a?"خطأ في التسجيل":"Registration Error",description:s,variant:"destructive"})}}),Z=l.useCallback(()=>{const t={};return r.firstName.trim()||(t.firstName=i("errors.required")),r.lastName.trim()||(t.lastName=i("errors.required")),r.username.trim()?/^[a-zA-Z0-9_]{3,20}$/.test(r.username.trim())||(t.username=a?"اسم المستخدم يجب أن يكون بين 3-20 حرف ويمكن أن يحتوي على أحرف إنجليزية وأرقام و_ فقط":"Username must be 3-20 characters and can only contain letters, numbers, and _"):t.username=i("errors.required"),r.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)||(t.email=i("errors.invalidEmail")):t.email=i("errors.required"),r.phone.trim()?/^05\d{8}$/.test(r.phone.replace(/\s/g,""))||(t.phone=i("errors.invalidPhone")):t.phone=i("errors.required"),r.password.trim()?r.password.length<6&&(t.password=i("errors.passwordTooShort")):t.password=i("errors.required"),T(t),Object.keys(t).length===0},[r,i,a]),Q=l.useCallback(()=>{Z()&&v.mutate(r.phone)},[Z,v,r.phone]),Y=l.useCallback(()=>{if(!y.trim()||y.length<4){m({title:a?"خطأ":"Error",description:a?"أدخل رمز التحقق":"Enter verification code",variant:"destructive"});return}E.mutate({phone:r.phone,otpCode:y})},[y,E,r.phone,a,m]),ee=l.useCallback(()=>{x.mutate({...r,certificateUrl:S||void 0})},[x,r,S]),te=l.useCallback(()=>{x.mutate({...r,certificateUrl:void 0})},[x,r]),j=l.useCallback(t=>s=>{A(c=>({...c,[t]:s.target.value})),d[t]&&T(c=>({...c,[t]:""}))},[d]),ae=l.useCallback(()=>{g?H(!1):P?(U(!1),V("")):f(p==="tasker"?"/tasker-type":"/role")},[f,p,g,P]),se=l.useCallback(t=>{var F;const s=(F=t.target.files)==null?void 0:F[0];if(!s)return;if(s.size>5*1024*1024){R(i("taskerType.certificate.fileTooLarge"));return}if(!s.type.startsWith("image/")){R(i("taskerType.certificate.invalidFormat"));return}R(null);const c=new FileReader;c.onloadend=()=>{z(c.result)},c.readAsDataURL(s)},[i]),ie=l.useCallback(()=>{z(null),h.current&&(h.current.value="")},[]),re=g?3:P?2:1,B=C?3:2;return e.jsxs("div",{className:"min-h-screen flex flex-col bg-gradient-to-b from-background to-primary/5 pt-safe",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(n.div,{initial:{opacity:0},animate:{opacity:.3},className:o("absolute -top-20 w-80 h-80 bg-accent/20 rounded-full blur-3xl",a?"-right-20":"-left-20")}),e.jsx(n.div,{initial:{opacity:0},animate:{opacity:.2},transition:{delay:.2},className:o("absolute bottom-40 w-64 h-64 bg-primary/15 rounded-full blur-3xl",a?"-left-20":"-right-20")})]}),e.jsxs(n.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex items-center justify-between px-6 py-4",children:[e.jsx(n.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:ae,className:"w-11 h-11 flex items-center justify-center rounded-2xl glass","data-testid":"button-back",children:e.jsx(fe,{className:o("w-5 h-5",a&&"rotate-180")})}),B>1&&e.jsx("div",{className:"flex gap-2",children:Array.from({length:B}).map((t,s)=>e.jsx(n.div,{initial:{scaleX:0},animate:{scaleX:1},transition:{delay:s*.1},className:o("w-10 h-1.5 rounded-full transition-colors",s<re?"bg-primary":"bg-muted")},s))}),e.jsx("div",{className:"w-11"})]}),e.jsx("div",{className:"flex-1 flex flex-col px-6 py-6 relative z-10 overflow-y-auto",children:e.jsx(D,{mode:"wait",children:P&&!g?e.jsxs(n.div,{initial:{opacity:0,x:a?20:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:a?-20:20},className:"flex-1 flex flex-col",children:[e.jsxs(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:o("mb-8",a&&"text-right"),children:[e.jsx("div",{className:"w-20 h-20 rounded-[1.5rem] bg-success/15 flex items-center justify-center mb-6 mx-auto",children:e.jsx(W,{className:"w-10 h-10 text-success"})}),e.jsx("h1",{className:"text-3xl font-extrabold text-foreground tracking-tight mb-2 text-center",children:a?"تحقق من رقم الجوال":"Verify Phone Number"}),e.jsx("p",{className:"text-muted-foreground text-lg text-center",children:a?`تم إرسال رمز التحقق إلى ${r.phone}`:`A verification code was sent to ${r.phone}`})]}),e.jsxs(n.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"space-y-6 flex-1",children:[e.jsx("div",{className:"relative",children:e.jsx("input",{type:"text",inputMode:"numeric",value:y,onChange:t=>V(t.target.value.replace(/\D/g,"").slice(0,6)),placeholder:a?"أدخل رمز التحقق":"Enter verification code",maxLength:6,autoComplete:"one-time-code",className:"w-full h-16 px-5 rounded-2xl glass-input text-foreground placeholder:text-muted-foreground focus:outline-none transition-all duration-200 text-center text-2xl tracking-[0.5em] font-bold","data-testid":"input-otp-code"})}),e.jsx("div",{className:"text-center",children:e.jsx("button",{onClick:()=>v.mutate(r.phone),disabled:v.isPending,className:"text-sm text-primary font-semibold hover:underline disabled:opacity-50","data-testid":"button-resend-otp",children:a?"إعادة إرسال الرمز":"Resend code"})})]}),e.jsx(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"mt-6 pb-safe",children:e.jsx(n.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:Y,disabled:E.isPending||!y.trim(),className:"w-full h-14 gradient-primary text-white rounded-2xl font-bold text-lg shadow-xl shadow-primary/25 transition-all disabled:opacity-60 flex items-center justify-center gap-2","data-testid":"button-verify-otp",children:E.isPending?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-5 h-5 animate-spin"}),i("common.loading")]}):a?"تأكيد الرمز":"Verify Code"})})]},"otp-step"):g?e.jsxs(n.div,{initial:{opacity:0,x:a?-20:20},animate:{opacity:1,x:0},exit:{opacity:0,x:a?20:-20},className:"flex-1 flex flex-col",children:[e.jsxs(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:o("mb-8",a&&"text-right"),children:[e.jsx("h1",{className:"text-3xl font-extrabold text-foreground tracking-tight mb-2",children:i("taskerType.certificate.title")}),e.jsx("p",{className:"text-muted-foreground text-lg",children:i("taskerType.certificate.description")})]}),e.jsxs(n.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"flex-1 space-y-6",children:[e.jsx("input",{ref:h,type:"file",accept:"image/*",onChange:se,className:"hidden","data-testid":"input-certificate"}),S?e.jsxs(n.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative w-full aspect-[4/3] rounded-3xl overflow-hidden glass",children:[e.jsx("img",{src:S,alt:"Certificate",className:"w-full h-full object-cover"}),e.jsx(n.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:ie,className:o("absolute top-4 w-10 h-10 rounded-full bg-black/60 backdrop-blur-md flex items-center justify-center text-white",a?"left-4":"right-4"),"data-testid":"button-remove-certificate",children:e.jsx(me,{className:"w-5 h-5"})}),e.jsx(n.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>{var t;return(t=h.current)==null?void 0:t.click()},className:"absolute bottom-4 left-1/2 -translate-x-1/2 px-6 py-2 rounded-full bg-white/90 dark:bg-black/80 backdrop-blur-md text-foreground font-medium shadow-lg","data-testid":"button-change-certificate",children:i("taskerType.certificate.changeImage")})]}):e.jsxs(n.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>{var t;return(t=h.current)==null?void 0:t.click()},className:"w-full aspect-[4/3] rounded-3xl glass border-2 border-dashed border-muted-foreground/30 flex flex-col items-center justify-center gap-4 transition-all hover:border-primary/50","data-testid":"button-upload-certificate",children:[e.jsx("div",{className:"w-16 h-16 rounded-2xl bg-primary/10 flex items-center justify-center",children:e.jsx(be,{className:"w-8 h-8 text-primary"})}),e.jsx("span",{className:"text-muted-foreground font-medium",children:i("taskerType.certificate.uploadPrompt")})]}),e.jsx(D,{children:$&&e.jsxs(n.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"flex items-center gap-2 p-4 rounded-2xl bg-destructive/10 text-destructive",children:[e.jsx(ue,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:$})]})}),e.jsxs(n.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.3},className:"flex items-start gap-3 p-4 rounded-2xl bg-amber-500/10 border border-amber-500/20",children:[e.jsx(ve,{className:"w-5 h-5 text-amber-600 dark:text-amber-400 shrink-0 mt-0.5"}),e.jsx("p",{className:o("text-sm text-amber-700 dark:text-amber-300",a&&"text-right"),children:i("taskerType.certificate.pendingNote")})]})]}),e.jsxs(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"mt-6 pb-safe space-y-3",children:[e.jsx(n.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:ee,disabled:x.isPending,className:"w-full h-14 gradient-primary text-white rounded-2xl font-bold text-lg shadow-xl shadow-primary/25 transition-all disabled:opacity-60 flex items-center justify-center gap-2","data-testid":"button-submit-certificate",children:x.isPending?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-5 h-5 animate-spin"}),i("auth.creatingAccount")]}):i("auth.register")}),e.jsx(n.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:te,disabled:x.isPending,className:"w-full h-14 glass text-foreground rounded-2xl font-bold text-lg transition-all disabled:opacity-60 flex items-center justify-center gap-2","data-testid":"button-skip-certificate",children:i("taskerType.certificate.skipForNow")})]})]},"certificate-step"):e.jsxs(n.div,{initial:{opacity:0,x:a?20:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:a?-20:20},className:"flex-1 flex flex-col",children:[e.jsxs(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:o("mb-8",a&&"text-right"),children:[e.jsx("h1",{className:"text-3xl font-extrabold text-foreground tracking-tight mb-2",children:i("auth.createAccount")}),e.jsx("p",{className:"text-muted-foreground text-lg",children:i(p==="tasker"?"auth.taskerRegisterDesc":"auth.clientRegisterDesc")})]}),e.jsxs(n.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"space-y-4 flex-1",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(w,{icon:L,label:a?"الاسم الأول":"First Name",value:r.firstName,onChange:j("firstName"),error:d.firstName,autoComplete:"given-name",testId:"input-first-name"})}),e.jsx("div",{className:"flex-1",children:e.jsx(w,{icon:L,label:a?"اسم العائلة":"Last Name",value:r.lastName,onChange:j("lastName"),error:d.lastName,autoComplete:"family-name",testId:"input-last-name"})})]}),e.jsx(w,{icon:L,label:a?"اسم المستخدم":"Username",value:r.username,onChange:j("username"),error:d.username,autoComplete:"username",testId:"input-username",dir:"ltr",required:!0}),e.jsx("p",{className:"text-xs text-muted-foreground text-center -mt-2 mb-2",children:a?"3-20 حرف، يمكن استخدام أحرف إنجليزية وأرقام و_":"3-20 characters, letters, numbers, and _ only"}),e.jsx(w,{icon:W,label:"05XXXXXXXX",type:"tel",value:r.phone,onChange:j("phone"),error:d.phone,autoComplete:"tel",testId:"input-phone",dir:"ltr"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center -mt-2 mb-2",children:a?"رقم جوال سعودي يبدأ بـ 05":"Saudi mobile number starting with 05"}),e.jsx(w,{icon:ge,label:i("auth.email"),type:"email",value:r.email,onChange:j("email"),error:d.email,autoComplete:"email",testId:"input-email",dir:"ltr"}),e.jsx(w,{icon:ye,label:i("auth.password"),value:r.password,onChange:j("password"),error:d.password,autoComplete:"new-password",showPasswordToggle:!0,showPassword:u,onTogglePassword:()=>K(!u),testId:"input-password"}),r.password&&e.jsxs(n.div,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},className:"space-y-2",children:[e.jsx("div",{className:"flex gap-1.5",children:[1,2,3,4].map(t=>e.jsx("div",{className:o("h-1.5 flex-1 rounded-full transition-all duration-300",t<=b.level?b.color:"bg-muted")},t))}),e.jsx("p",{className:o("text-xs font-medium",b.level<=1&&"text-destructive",b.level===2&&"text-warning",b.level>=3&&"text-success",a&&"text-right"),children:b.label})]})]}),e.jsxs(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"mt-6 pb-safe",children:[e.jsx(n.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:Q,disabled:v.isPending,className:"w-full h-14 gradient-primary text-white rounded-2xl font-bold text-lg shadow-xl shadow-primary/25 transition-all disabled:opacity-60 flex items-center justify-center gap-2","data-testid":"button-create-account",children:v.isPending?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-5 h-5 animate-spin"}),i("common.loading")]}):a?"تحقق من رقم الجوال":"Verify Phone"}),e.jsxs("p",{className:o("text-center text-muted-foreground mt-6",a&&"text-center"),children:[i("auth.haveAccount")," ",e.jsx(de,{href:"/login",className:"text-primary font-bold hover:underline",children:i("auth.signIn")})]})]})]},"form-step")})})]})});export{Re as default};
