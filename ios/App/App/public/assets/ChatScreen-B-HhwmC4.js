import{r as s,k as F,u as _,j as t,m as d,A as H,c as p,e as J,q as Q}from"./index-CzK-Wtpj.js";import{u as k}from"./useQuery-B1e_qTp-.js";import{u as z}from"./useMutation-BXgiM4Zs.js";import{S as M,E as B}from"./animated-ifqYnJC-.js";import{A as W,a as I,b as P}from"./avatar-CPrQWbpQ.js";import{A as V}from"./arrow-left-eQXjCarb.js";import{M as X}from"./message-circle-BzmAey6U.js";import{S as Y}from"./send-9v2j9KhO.js";import"./utils-km2FGkQ4.js";const ce=s.memo(function(){var T;const{taskId:i}=F();_();const[f,C]=s.useState(""),[h,g]=s.useState([]),E=s.useRef(null),q=s.useRef(null),n=s.useRef(null),w=s.useRef(null),x=s.useRef(0),[Z,A]=s.useState(!1),j=!!localStorage.getItem("userId"),{data:m}=k({queryKey:["/api/users/me"],enabled:j}),{data:a}=k({queryKey:["/api/tasks",i],enabled:j&&!!i}),{data:b,isLoading:K}=k({queryKey:["/api/tasks",i,"messages"],refetchInterval:3e3,enabled:j&&!!i});s.useEffect(()=>{if(!i)return;const e=5,o=1e3,l=()=>{const y=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws?taskId=${i}`;try{n.current=new WebSocket(y),n.current.onopen=()=>{console.log("[WS] Connected"),A(!0),x.current=0},n.current.onmessage=c=>{try{const{type:u,data:D}=JSON.parse(c.data);u==="message"&&g(L=>[...L,D])}catch(u){console.error("[WS] Failed to parse message",u)}},n.current.onclose=c=>{if(console.log("[WS] Disconnected",c.code,c.reason),A(!1),c.code!==1e3&&x.current<e){const u=o*Math.pow(2,x.current);console.log(`[WS] Reconnecting in ${u}ms (attempt ${x.current+1})`),w.current=setTimeout(()=>{x.current++,l()},u)}},n.current.onerror=c=>{console.error("[WS] Error:",c)}}catch(c){console.error("[WS] Connection failed, falling back to polling",c)}};return l(),()=>{w.current&&clearTimeout(w.current),n.current&&n.current.close(1e3)}},[i]),s.useEffect(()=>{b&&g(b)},[b]);const N=z({mutationFn:async e=>(await J("POST",`/api/tasks/${i}/messages`,{content:e})).json(),onSuccess:e=>{g(o=>[...o,e]),Q.invalidateQueries({queryKey:["/api/tasks",i,"messages"]}),C(""),n.current&&n.current.readyState===WebSocket.OPEN&&n.current.send(JSON.stringify({type:"message",data:e}))}});s.useEffect(()=>{var e;(e=E.current)==null||e.scrollIntoView({behavior:"smooth"})},[h]);const S=s.useCallback(()=>{f.trim()&&N.mutate(f.trim())},[f,N]),O=s.useCallback(e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),S())},[S]),$=s.useCallback(e=>(typeof e=="string"?new Date(e):e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}),[]),R=s.useCallback(e=>e.split(" ").map(o=>o[0]).join("").toUpperCase().slice(0,2),[]),r=((T=a==null?void 0:a.client)==null?void 0:T.id)===(m==null?void 0:m.id)?a==null?void 0:a.tasker:a==null?void 0:a.client;return t.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-background to-primary/5 flex flex-col",children:[t.jsxs(d.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex items-center gap-4 px-6 py-4 glass border-b border-white/10 sticky top-0 z-10 pt-safe",children:[t.jsx(d.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>window.history.back(),className:"w-10 h-10 flex items-center justify-center rounded-2xl glass-button","data-testid":"button-back",children:t.jsx(V,{className:"w-5 h-5"})}),t.jsxs(W,{className:"w-11 h-11 border-2 border-white/20 shadow-lg",children:[t.jsx(I,{src:(r==null?void 0:r.avatar)||void 0}),t.jsx(P,{className:"gradient-primary text-white font-bold text-sm",children:r!=null&&r.name?R(r.name):"U"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h2",{className:"font-bold text-foreground truncate",children:(r==null?void 0:r.name)||"Chat"}),t.jsx("p",{className:"text-xs text-muted-foreground truncate",children:a==null?void 0:a.title})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-4 space-y-4",children:[t.jsx(H,{mode:"wait",children:K&&h.length===0?t.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"space-y-4",children:[1,2,3].map(e=>t.jsxs("div",{className:p("flex gap-3",e%2===0&&"justify-end"),children:[e%2!==0&&t.jsx(M,{className:"w-8 h-8 rounded-full flex-shrink-0"}),t.jsx(M,{className:p("h-16 rounded-2xl",e%2===0?"w-2/3":"w-3/4")})]},e))},"loading"):h.length>0?t.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"space-y-4",children:h.map((e,o)=>{var v,y;const l=e.senderId===(m==null?void 0:m.id);return t.jsxs(d.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:o*.03},className:p("flex gap-3",l&&"justify-end"),children:[!l&&t.jsxs(W,{className:"w-8 h-8 border border-white/20 flex-shrink-0 shadow",children:[t.jsx(I,{src:((v=e.sender)==null?void 0:v.avatar)||void 0}),t.jsx(P,{className:"gradient-primary text-white font-bold text-xs",children:(y=e.sender)!=null&&y.name?R(e.sender.name):"U"})]}),t.jsxs("div",{className:p("max-w-[75%]",l&&"order-first"),children:[t.jsx("div",{className:p("px-4 py-3 rounded-2xl shadow-sm",l?"gradient-primary text-white rounded-br-md":"glass rounded-bl-md"),children:t.jsx("p",{className:"text-sm leading-relaxed",children:e.content})}),t.jsx("p",{className:p("text-xs text-muted-foreground mt-1.5",l&&"text-right"),children:$(e.createdAt)})]})]},e.id)})},"messages"):t.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"h-full flex items-center justify-center",children:t.jsx(B,{icon:t.jsx(X,{className:"w-8 h-8"}),title:"No messages yet",description:"Start the conversation"})},"empty")}),t.jsx("div",{ref:E})]}),t.jsx(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"sticky bottom-0 left-0 right-0 p-4 glass border-t border-white/10 pb-safe",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{ref:q,type:"text",value:f,onChange:e=>C(e.target.value),onKeyPress:O,placeholder:"Type a message...",className:"flex-1 h-12 px-5 rounded-2xl glass-input text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all","data-testid":"input-message"}),t.jsx(d.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:S,disabled:!f.trim()||N.isPending,className:"w-12 h-12 gradient-primary text-white rounded-2xl flex items-center justify-center shadow-lg shadow-primary/30 transition-all disabled:opacity-50","data-testid":"button-send",children:t.jsx(Y,{className:"w-5 h-5"})})]})})]})});export{ce as default};
