import{j as a,c as W,u as D,b as I,d as H,a as R,r as d,m as n,e as z,q as w}from"./index-CzK-Wtpj.js";import{F as u}from"./FloatingInput-Q9Q65xjP.js";import{u as K}from"./useQuery-B1e_qTp-.js";import{u as M}from"./useMutation-BXgiM4Zs.js";import{A as Q,a as O,b as B}from"./avatar-CPrQWbpQ.js";import{L as P}from"./loader-circle-AYqjcifH.js";import{A as $}from"./arrow-left-eQXjCarb.js";import{C as Z}from"./camera-B3Gnq2Ue.js";import"./utils-km2FGkQ4.js";function j({children:c,className:x,safeAreaBottom:m=!0,safeAreaTop:i=!0,noPadding:t=!1,...p}){return a.jsx("div",{className:W("flex flex-col min-h-screen w-full bg-background",i&&"pt-safe",m&&"pb-[calc(env(safe-area-inset-bottom)+80px)]",!t&&"px-4",x),...p,children:c})}function se(){const[,c]=D(),{setUser:x,user:m}=I(),{toast:i}=H(),{t}=R(),p=d.useRef(null),{data:g,isLoading:F}=K({queryKey:["/api/users/me"],queryFn:async()=>{const e=await fetch("/api/users/me",{credentials:"include"});if(!e.ok)throw e.status===401?(setTimeout(()=>c("/login"),1e3),new Error("Not authenticated")):new Error("Failed to fetch user");return await e.json()},retry:!1,refetchOnWindowFocus:!0,refetchOnMount:!0}),[s,N]=d.useState({name:"",username:"",email:"",phone:"",bio:"",location:""}),[h,v]=d.useState(null),[f,C]=d.useState({});d.useEffect(()=>{const e=g||m;e&&(N({name:e.name||"",username:e.username||"",email:e.email||"",phone:e.phone||"",bio:e.bio||"",location:e.location||""}),v(e.avatar||null))},[g,m]);const k=()=>{var e;(e=p.current)==null||e.click()},E=e=>{var l;const r=(l=e.target.files)==null?void 0:l[0];if(r){if(!r.type.startsWith("image/")){i({title:t("errors.somethingWentWrong"),description:t("profile.invalidImageType")||"Please select an image file",variant:"destructive"});return}if(r.size>5*1024*1024){i({title:t("errors.somethingWentWrong"),description:t("profile.imageTooLarge")||"Image size must be less than 5MB",variant:"destructive"});return}const y=new FileReader;y.onload=q=>{var T;const A=(T=q.target)==null?void 0:T.result;A&&(v(A),i({title:t("profile.imageSelected")||"Image selected",description:t("profile.clickSaveToUpdate")||"Click Save to update your profile picture"}))},y.onerror=()=>{i({title:t("errors.somethingWentWrong"),description:t("profile.imageLoadError")||"Failed to load image",variant:"destructive"})},y.readAsDataURL(r)}},b=M({mutationFn:async e=>(await z("PATCH","/api/users/me",e)).json(),onSuccess:e=>{x(e),e.avatar&&v(e.avatar),w.invalidateQueries({queryKey:["/api/users/me"]}),w.invalidateQueries({queryKey:["/api/users",e.id]}),w.invalidateQueries({queryKey:["/api/users"]}),i({title:t("profile.editProfile"),description:t("profile.profileUpdated")||t("common.save")}),c("/profile")},onError:e=>{i({title:t("errors.somethingWentWrong"),description:e.message,variant:"destructive"})}}),L=()=>{const e={};return s.name.trim()||(e.name="Name is required"),s.username.trim()?/^[a-zA-Z0-9_]{3,20}$/.test(s.username.trim())||(e.username=t("auth.invalidUsername")):e.username=t("errors.required"),s.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email)||(e.email="Invalid email"):e.email="Email is required",C(e),Object.keys(e).length===0},S=()=>{var e;if(L()){const r={...s};h&&(r.avatar=h,console.log("[Profile] Updating avatar, preview length:",h.length)),console.log("[Profile] Submitting profile update:",{hasAvatar:!!r.avatar,avatarLength:(e=r.avatar)==null?void 0:e.length}),b.mutate(r)}},o=e=>r=>{N(l=>({...l,[e]:r.target.value})),f[e]&&C(l=>({...l,[e]:""}))},U=e=>e.split(" ").map(r=>r[0]).join("").toUpperCase().slice(0,2);return F?a.jsx(j,{className:"px-6",children:a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx(P,{className:"w-8 h-8 animate-spin text-primary"})})}):g||m?a.jsxs(j,{className:"px-6",children:[a.jsxs(n.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex items-center gap-4 py-4 mb-4",children:[a.jsx(n.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>window.history.back(),className:"w-11 h-11 flex items-center justify-center rounded-2xl glass","data-testid":"button-back",children:a.jsx($,{className:"w-5 h-5 text-foreground/80 rtl:rotate-180"})}),a.jsx("h1",{className:"text-2xl font-extrabold text-foreground",children:t("profile.editProfile")})]}),a.jsxs(n.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center mb-8",children:[a.jsxs("div",{className:"relative",children:[a.jsx("input",{ref:p,type:"file",accept:"image/*",onChange:E,className:"hidden","data-testid":"input-avatar-file"}),a.jsxs(n.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:k,className:"cursor-pointer",children:[a.jsx("div",{className:"absolute -inset-1 bg-gradient-to-br from-primary/40 to-accent/40 rounded-full blur-md"}),a.jsxs(Q,{className:"relative w-28 h-28 border-4 border-white/50 dark:border-white/20 shadow-2xl",children:[a.jsx(O,{src:h||void 0}),a.jsx(B,{className:"gradient-primary text-white text-3xl font-bold",children:s.name?U(s.name):"U"})]})]}),a.jsx(n.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:k,className:"absolute -bottom-1 -right-1 w-10 h-10 gradient-primary text-white rounded-2xl flex items-center justify-center shadow-lg shadow-primary/30 border-2 border-white/50 rtl:-left-1 rtl:right-auto","data-testid":"button-change-avatar",children:a.jsx(Z,{className:"w-4 h-4"})})]}),a.jsx("p",{className:"text-sm text-muted-foreground mt-4 text-center",children:t("profile.changeAvatar")||"Tap to change profile picture"})]}),a.jsxs("div",{className:"space-y-4 flex-1",children:[a.jsx(u,{label:"Full Name",value:s.name,onChange:o("name"),error:f.name}),a.jsx(u,{label:t("auth.username")||"Username",value:s.username,onChange:o("username"),error:f.username,dir:"ltr"}),a.jsx(u,{label:"Email Address",type:"email",value:s.email,onChange:o("email"),error:f.email}),a.jsx(u,{label:"Phone Number",type:"tel",value:s.phone,onChange:o("phone")}),a.jsx(u,{label:"Location",value:s.location,onChange:o("location")}),a.jsxs("div",{className:"relative",children:[a.jsx("textarea",{value:s.bio,onChange:o("bio"),placeholder:"Tell others about yourself...",className:"w-full h-32 p-4 rounded-2xl border-2 border-transparent bg-card shadow-sm outline-none transition-all placeholder:text-muted-foreground font-medium text-foreground resize-none focus:border-primary/50","data-testid":"textarea-bio"}),a.jsx("label",{className:"absolute left-4 top-3 text-[10px] font-bold text-primary uppercase tracking-wider",children:"Bio"})]})]}),a.jsx(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"mt-8 pb-4",children:a.jsx(n.button,{whileHover:{scale:1.01},whileTap:{scale:.98},onClick:S,disabled:b.isPending,className:"w-full h-14 gradient-primary text-white rounded-2xl font-bold text-lg shadow-lg shadow-primary/25 disabled:opacity-50 disabled:shadow-none transition-all","data-testid":"button-save-profile",children:b.isPending?a.jsxs("div",{className:"flex items-center justify-center gap-2",children:[a.jsx(P,{className:"w-5 h-5 animate-spin"}),t("common.loading")]}):t("common.save")})})]}):a.jsx(j,{className:"px-6",children:a.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen",children:[a.jsx("p",{className:"text-muted-foreground mb-4",children:t("errors.unauthorized")||"Please login to edit your profile"}),a.jsx(n.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>c("/login"),className:"px-6 py-3 gradient-primary text-white rounded-2xl font-bold",children:t("auth.login")})]})})}export{se as default};
